pipeline {
	agent any
	tools {nodejs "my_node"}
	environment {
		pomme = "${params.pomme}"
	}
    stages {

		stage('Build') {
            steps {
                sh 'npm ci'
            }
        }

		stage('display') {
            steps {
				sh "pwd"
				sh "ls -la ../"
            }
        }

		stage('test') {
            steps {
                sh 'npm run test-jenkins --testMatch dist/tests/passwordReset.test.js'
            }
        }

        stage('SonarQube analysis') {
			steps {
				script {
					scannerHome = tool 'SonarScanner'
				}
				withSonarQubeEnv('my_server') {
					sh "${scannerHome}/bin/sonar-scanner"
				}
			}
    	}

		stage('Deploy') {
			steps {
				script {
					sh "if [ \"$(git remote -v | grep heroku)\" != ''  ];then git remote add heroku https://github.com/RemyMach/Mindory.git; else echo \"repo heroku already present\"; fi"
					sh "git push heroku main"
				}
			}
    	}
	}
}